<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- Include Font Awesome for icons -->
</head>
<body>
    <div class="navbar">
        <a href="./#home">Home</a>
        <a href="settings.html">Settings</a>
        <div class="status">
            <span id="current-temp">Temp: -- °C</span>
            <span id="fan-status">Fan: --</span>
        </div>
    </div>
    <h1 id="deviceName">MasterPi Smoker</h1>
    <h1>Settings</h1>
    <div class="container">
        <div class="sidebar">
            <ul>
                <li><a href="#" class="tab-link" data-tab="general">General</a></li>
                <li><a href="#" class="tab-link" data-tab="devices">Devices</a></li>
                <li><a href="#" class="tab-link" data-tab="integrations">Integrations</a></li>
            </ul>
        </div>
        <div class="content">
            <div id="messageContainer"></div>
            <form id="settingsForm">
                <div id="general" class="tab-content">
                    <h2>General</h2>
                    <div>
                        <label for="device_name">Device Name:</label>
                        <input type="text" id="device_name" name="device_name" placeholder="Device Name">
                    </div>
                    <div>
                        <label for="temp_unit">Temperature Unit:</label>
                        <select id="temp_unit" name="temp_unit">
                            <option value="C">Celsius</option>
                            <option value="F">Fahrenheit</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" id="saveGeneral">Save General Settings</button>
                    </div>
                </div>
                <div id="devices" class="tab-content">
                    <h2>Devices</h2>
                    <div>
                        <label for="temp_offset">Temperature Offset:</label>
                        <input type="number" id="temp_offset" name="temp_offset" placeholder="Offset in degrees">
                    </div>
                    <div>
                        <label for="pid_autotune">PID Autotune:</label>
                        <button id="pid_autotune">Start Autotune</button>
                    </div>
                    <div>
                        <label for="sensor_type_max31865">Enable MAX31865:</label>
                        <input type="checkbox" id="sensor_type_max31865" name="sensor_type_max31865">
                    </div>
                    <div>
                        <label for="sensor_type_max31855">Enable MAX31855:</label>
                        <input type="checkbox" id="sensor_type_max31855" name="sensor_type_max31855">
                    </div>
                    <div>
                        <label for="sensor_type_ads1115">Enable ADS1115:</label>
                        <input type="checkbox" id="sensor_type_ads1115" name="sensor_type_ads1115">
                    </div>
                    <div>
                        <label for="sensor_count">Number of Sensors:</label>
                        <input type="number" id="sensor_count" name="sensor_count" min="1" max="4" value="1">
                    </div>
                    <div>
                        <button type="button" id="saveDevices">Save Device Settings</button>
                    </div>
                    <div>
                        <label for="sensor_count">Number of Sensors:</label>
                        <input type="number" id="sensor_count" name="sensor_count" min="1" max="4" value="1">
                    </div>
                    <div>
                        <button type="button" id="saveDevices">Save Device Settings</button>
                    </div>
                </div>
                <div id="integrations" class="tab-content">
                    <h2>Integrations</h2>
                    <div>
                        <label for="meater_integration">Enable Meater Integration:</label>
                        <input type="checkbox" id="meater_integration" name="meater_integration">
                    </div>
                    <div id="meaterStatus">Meater connection status will be displayed here.</div>
                    <div id="meater-temp">Meater temperature will be displayed here.</div>
                    <div>
                        <label for="meater_email">Meater Cloud Email:</label>
                        <input type="email" id="meater_email" name="meater_email" placeholder="Meater Cloud Email">
                    </div>
                    <div>
                        <label for="meater_password">Meater Cloud Password:</label>
                        <input type="password" id="meater_password" name="meater_password" placeholder="Meater Cloud Password">
                    </div>
                    <div>
                        <button type="button" id="saveIntegrations">Save Integration Settings</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Tab navigation
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const tab = this.getAttribute('data-tab');

                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });

                    document.getElementById(tab).classList.add('active');
                });
            });

            // Set default tab
            document.querySelector('.tab-link[data-tab="general"]').click();

            // Fetch settings
            fetch('/get_settings')
                .then(response => response.json())
                .then(settings => {
                    const deviceNameElement = document.getElementById('deviceName');
                    if (deviceNameElement) {
                        deviceNameElement.textContent = settings.device_name;
                    }
                    const deviceNameInput = document.getElementById('device_name');
                    if (deviceNameInput) {
                        deviceNameInput.value = settings.device_name;
                    }
                    const tempOffsetInput = document.getElementById('temp_offset');
                    if (tempOffsetInput) {
                        tempOffsetInput.value = settings.temp_offset;
                    }
                    const tempUnitSelect = document.getElementById('temp_unit');
                    if (tempUnitSelect) {
                        tempUnitSelect.value = settings.temp_unit;
                    }
                    const meaterIntegrationCheckbox = document.getElementById('meater_integration');
                    if (meaterIntegrationCheckbox) {
                        meaterIntegrationCheckbox.checked = settings.meater_integration;
                    }
                    const meaterEmailInput = document.getElementById('meater_email');
                    if (meaterEmailInput) {
                        meaterEmailInput.value = settings.meater_email;
                    }
                    const meaterPasswordInput = document.getElementById('meater_password');
                    if (meaterPasswordInput) {
                        meaterPasswordInput.value = settings.meater_password;
                    }
                    const sensorTypeSelect = document.getElementById('sensor_type');
                    if (sensorTypeSelect) {
                        sensorTypeSelect.value = settings.sensor_type;
                    }
                    const sensorCountInput = document.getElementById('sensor_count');
                    if (sensorCountInput) {
                        sensorCountInput.value = settings.sensor_count;
                    }
                })
                .catch(error => {
                    console.error('Error fetching settings:', error);
                });

            // Fetch status
            function fetchStatus() {
                fetch('/get_status')
                    .then(response => response.json())
                    .then(status => {
                        const tempStatusElement = document.getElementById('current-temp');
                        if (tempStatusElement) {
                            tempStatusElement.textContent = `Temp: ${status.temperature} °C`;
                        }
                        const fanStatusElement = document.getElementById('fan-status');
                        if (fanStatusElement) {
                            fanStatusElement.textContent = `Fan: ${status.fan_on ? 'On' : 'Off'}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                    });
            }

            // Initial fetch and set interval for periodic updates
            fetchStatus();
            setInterval(fetchStatus, 5000);

            // Save General Settings
            document.getElementById('saveGeneral').addEventListener('click', function() {
                const formData = new FormData();
                formData.append('device_name', document.getElementById('device_name').value);
                formData.append('temp_unit', document.getElementById('temp_unit').value);

                fetch('/save_general_settings', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'General settings saved successfully!';
                        const deviceNameElement = document.getElementById('deviceName');
                        if (deviceNameElement) {
                            deviceNameElement.textContent = data.device_name;
                        }
                    } else {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'Failed to save general settings.';
                    }
                })
                .catch(error => {
                    console.error('Error saving general settings:', error);
                    const messageContainer = document.getElementById('messageContainer');
                    messageContainer.textContent = 'Error saving general settings: ' + error.message;
                });
            });

            // Save Device Settings
            document.getElementById('saveDevices').addEventListener('click', function() {
                const formData = new FormData();
                formData.append('temp_offset', document.getElementById('temp_offset').value);
                formData.append('sensor_type', document.getElementById('sensor_type').value);
                formData.append('sensor_count', document.getElementById('sensor_count').value);

                fetch('/save_device_settings', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'Device settings saved successfully!';
                    } else {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'Failed to save device settings.';
                    }
                })
                .catch(error => {
                    console.error('Error saving device settings:', error);
                    const messageContainer = document.getElementById('messageContainer');
                    messageContainer.textContent = 'Error saving device settings: ' + error.message;
                });
            });

            // Save Integration Settings
            document.getElementById('saveIntegrations').addEventListener('click', function() {
                const formData = new FormData();
                formData.append('meater_integration', document.getElementById('meater_integration').checked);
                formData.append('meater_email', document.getElementById('meater_email').value);
                formData.append('meater_password', document.getElementById('meater_password').value);

                fetch('/save_integration_settings', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'Integration settings saved successfully!';
                    } else {
                        const messageContainer = document.getElementById('messageContainer');
                        messageContainer.textContent = 'Failed to save integration settings.';
                    }
                })
                .catch(error => {
                    console.error('Error saving integration settings:', error);
                    const messageContainer = document.getElementById('messageContainer');
                    messageContainer.textContent = 'Error saving integration settings: ' + error.message;
                });
            });
        });
    </script>
</body>
</html>